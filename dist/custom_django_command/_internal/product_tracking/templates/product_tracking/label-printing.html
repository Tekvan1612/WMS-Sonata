{% include 'product_tracking/head.html' %}

{% block content %}
<body>
<div id="alert-container"></div>
<!-- Begin page -->
<div id="layout-wrapper">
    <!-- ========== App Menu ========== -->
    {% include 'product_tracking/menu.html' %}
    <!-- Left Sidebar End -->
    <!-- Vertical Overlay-->
    <div class="vertical-overlay"></div>
    {% include 'product_tracking/header.html' %}
    <div class="wrapper"></div>

    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                            <h4 class="mb-sm-0">Label Printing</h4>
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Production</a></li>
                                    <li class="breadcrumb-item active">Label Printing</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end page title -->

                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title mb-0">Label Printing</h4>
                            </div><!-- end card header -->
                            <div class="card-body">
                                <form id="labelPrintingForm">
                                    {% csrf_token %}
                                    <div class="row g-3">
                                        <div class="col-lg-3">
                                            <div class="form-floating">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="labelType"
                                                           id="polybag" value="polybag" checked>
                                                    <label class="form-check-label" for="polybag">
                                                        Polybag Label
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="labelType"
                                                           id="carton" value="carton">
                                                    <label class="form-check-label" for="carton">
                                                        Carton Label
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-lg-3" id="scan-qr-code">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="qr-code"
                                                       placeholder="Scan QR Code" name="qr_code">
                                                <label for="qr-code">Scan QR Code</label>
                                            </div>
                                        </div>

                                        <div class="col-lg-3" id="polybag-count"
                                             style="display: none; margin-top: 25px;">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="polybag-count-input"
                                                       placeholder="Polybag Count" readonly>
                                                <label for="polybag-count-input">Polybag Count</label>
                                            </div>
                                        </div>

                                        <div class="col-lg-3 polybag-fields">
                                            <div class="form-floating">
                                                <select class="form-select" id="select-production-order"
                                                        aria-label="Select PO Number">
                                                    <!-- Options will be added dynamically -->
                                                </select>
                                                <label for="select-production-order">Production Order Number</label>
                                            </div>
                                        </div>

                                        <div class="col-lg-3 polybag-fields">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="item-code"
                                                       placeholder="Enter Item Code" readonly>
                                                <label for="item-code">Item Code</label>
                                            </div>
                                        </div>

                                        <div class="col-lg-3 polybag-fields">
                                            <div class="form-floating">
                                                <input class="form-control" id="product-name"
                                                       placeholder="Enter Item Name" readonly>
                                                <label for="product-name">Item Name</label>
                                            </div>
                                        </div>

                                        <div class="col-lg-3 polybag-fields">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="batch"
                                                       placeholder="Enter Batch" readonly>
                                                <label for="batch">Item Batch</label>
                                            </div>
                                        </div>

                                        <div class="col-lg-3 polybag-fields">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="mrp"
                                                       placeholder="Enter MRP" readonly>
                                                <label for="mrp">Item MRP</label>
                                            </div>
                                        </div>

                                        <div class="col-lg-3 polybag-fields">
                                            <div class="form-floating">
                                                <input type="date" class="form-control" id="mfg-date" readonly>
                                                <label for="mfg-date">MFG Date</label>
                                            </div>
                                        </div>

                                        <div class="col-lg-3 polybag-fields">
                                            <div class="form-floating">
                                                <input type="date" class="form-control" id="exp-date" readonly>
                                                <label for="exp-date">EXP. Date</label>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 polybag-fields">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="qty"
                                                       placeholder="Enter Quantity" readonly>
                                                <label for="qty">Quantity</label>
                                            </div>
                                        </div>

                                        <div class="col-lg-12 polybag-fields">
                                            <div class="">
                                                <textarea class="form-control" id="live-weight-display"
                                                          placeholder="Live Weight Display" rows="3"
                                                          readonly></textarea>

                                            </div>
                                        </div>

                                    </div>
                                </form>
                            </div>
                        </div>
                    </div><!--end col-->
                </div><!--end row-->

                <!-- Table to display carton labels -->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-body mt-3">
                                <div class="table-responsive">
                                    <table id="cartonLabelsTable"
                                           class="table table-bordered dt-responsive nowrap table-striped align-middle"
                                           style="width:100%">
                                        <thead style="background: rgba(155,198,221,0.58)">
                                        <tr>
                                            <th>Carton Label</th>
                                            <th>Item Code</th>
                                            <th>Batch</th>
                                            <th>Printed By</th>
                                            <th>Printed Date</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <!-- Data will be inserted here by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!--end row-->
            </div> <!-- container-fluid -->
        </div>
        <!-- End Page-content -->
        {% include 'product_tracking/footer.html' %}
    </div>
    <!-- end main content-->
</div>
<!-- END layout-wrapper -->

<!-- Modal HTML placed directly before the closing body tag -->
<div class="modal fade" id="editProductionOrderModal" tabindex="-1"
     aria-labelledby="editProductionOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProductionOrderModalLabel">Edit Production Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProductionOrderForm">
                    <input type="hidden" id="edit-production-order-number">
                    <div class="form-floating mb-3">
                        <select class="form-select" id="edit-select-item" aria-label="Select Item Code"></select>
                        <label for="edit-select-item">Item Code</label>
                    </div>
                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="edit-product-name" rows="3" placeholder="Enter Item Name" readonly></textarea>
                        <label for="edit-product-name">Item Name</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="edit-batch" placeholder="Enter Batch">
                        <label for="edit-batch">Item Batch</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="edit-mrp" placeholder="Enter MRP">
                        <label for="edit-mrp">Item MRP</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="date" class="form-control" id="edit-mfg-date">
                        <label for="edit-mfg-date">MFG Date</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="date" class="form-control" id="edit-exp-date">
                        <label for="edit-exp-date">EXP Date</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="edit-qty" placeholder="Enter Quantity">
                        <label for="edit-qty">QTY</label>
                    </div>
                    <div class="form-floating mb-3">
                        <select class="form-select" id="edit-line-no" aria-label="Select Line Number"></select>
                        <label for="edit-line-no">Line Number</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="edit-polybag-weight" placeholder="Enter Weight">
                        <label for="edit-polybag-weight">Polybag Weight</label>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<style>
    .form-floating > .form-select:focus ~ label,
    .form-floating > .form-select:not(:placeholder-shown) ~ label,
    .form-floating > .form-control:focus ~ label,
    .form-floating > .form-control:not(:placeholder-shown) ~ label {
        transform: translateY(-1.5rem) scale(0.85);
        color: #000000;
        opacity: 1;
    }

    .form-floating > .select2-container--default .select2-selection--single {
        height: calc(3.5rem + 2px); /* Adjust based on form control height */
        padding: .75rem 1rem;
    }

    .form-floating > .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 2.25rem; /* Adjust based on form control height */
        font-size: 0.85rem; /* Adjust the font size as needed */
        color: black !important;
    }

    .form-floating > .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: calc(3.5rem + 2px); /* Adjust based on form control height */
    }

    .select2-selection__clear {
        display: none; /* Hide the clear (red cross) button */
    }

    /* Ensure the label stays within the div */
    .form-floating > label {
        z-index: 1;
        pointer-events: none;
        left: 1rem;
    }

    .form-floating > .form-select,
    .form-floating > .form-control {
        z-index: 2;
    }

    .select2-selection__placeholder {
        color: black !important;
        font-size: 0.85rem;
    }

    #live-weight-display {
        background-color: black;
        color: lime;
        font-family: monospace;
        overflow-y: scroll;
        resize: none;
    }

    .stable {
        color: lime;
    }

    .unstable {
        color: red;
    }

    #alert-container {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 10000;
    }

    .alert {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
        font-size: 16px;
    }
</style>

<script>
    $(document).ready(function () {
        let previousWeight = null;
        let weightStableCount = 0;
        const stabilityThreshold = 5; // Number of consecutive stable readings required
        let isStableDisplayed = false; // Flag to check if the stable weight has already been displayed
        let isStable = false; // Flag to track the stability state

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        function showAlert(message, type) {
            console.log('Showing alert:', message, 'of type:', type);
            const alertBox = $('<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' + message + '</div>');
            $('#alert-container').append(alertBox);
            console.log('Alert box appended to alert-container:', alertBox);
            setTimeout(function () {
                alertBox.fadeOut(500, function () {
                    console.log('Alert box faded out:', alertBox);
                    $(this).remove();
                });
            }, 2000); // Alert stays for 2 seconds
        }

        function getLiveWeight() {
            var productionOrderNo = $('#select-production-order').val();
            if (!productionOrderNo) {
                return;
            }

            $.ajax({
                url: '/get_weight/',
                type: 'POST',
                data: {
                    production_order_no: productionOrderNo,
                    csrfmiddlewaretoken: csrftoken
                },
                success: function (data) {
                    if (data.error) {
                        $('#weight-status').val(data.error).css('color', 'red');
                        $('#live-weight-display').removeClass('stable').addClass('unstable').val('Error: ' + data.error + '\n').css('color', 'red');
                        isStableDisplayed = false;
                        isStable = false;
                        return;
                    }

                    var weight = parseFloat(data.weight);

                    if (isNaN(weight)) {
                        $('#weight-status').val('Error reading weight').css('color', 'red');
                        $('#live-weight-display').removeClass('stable').addClass('unstable').val('Error: NaN kg\n').css('color', 'red');
                        isStableDisplayed = false;
                        isStable = false;
                        return;
                    }

                    if (previousWeight !== null && weight === previousWeight) {
                        weightStableCount++;
                    } else {
                        weightStableCount = 0;
                        previousWeight = weight;
                        isStableDisplayed = false;
                        isStable = false;
                    }

                    if (weightStableCount >= stabilityThreshold) {
                        $('#weight-status').val('Stable').css('color', 'green');
                        $('#live-weight-display').removeClass('unstable').addClass('stable').css('color', 'green').val('Stable Weight: ' + weight + ' kg\n');
                        if (!isStableDisplayed) {
                            isStableDisplayed = true; // Mark as displayed
                            isStable = true; // Mark as stable

                            console.log('Stable weight detected:', weight, 'at', new Date().toLocaleTimeString());
                            // Auto print the label if within tolerance
                            checkAndPrintLabel(productionOrderNo, weight);
                        }
                    } else {
                        if (!isStable) {
                            var liveWeightDisplay = $('#live-weight-display');
                            liveWeightDisplay.val('Weight: ' + weight + ' kg\n').css('color', 'red');
                            liveWeightDisplay.scrollTop(liveWeightDisplay[0].scrollHeight);
                            $('#live-weight-display').removeClass('stable').addClass('unstable');
                            $('#weight-status').val('Unstable').css('color', 'red');
                        }
                    }
                },
                error: function (xhr, status, error) {
                    if (xhr.status === 401) {
                        showAlert('Session expired. Redirecting to login page.', 'danger');
                        window.location.href = '/login/';
                    } else {
                        $('#weight-status').val('Error fetching weight.').css('color', 'red');
                        $('#live-weight-display').removeClass('stable').addClass('unstable').val('Error: ' + error + '\n').css('color', 'red');
                        isStableDisplayed = false;
                        isStable = false;
                    }
                }
            });
        }

        function checkAndPrintLabel(productionOrderNo, weight) {
            console.log('Checking tolerance for weight:', weight, 'at', new Date().toLocaleTimeString());
            $.ajax({
                url: '/get_tolerance_value/',
                type: 'GET',
                success: function (toleranceData) {
                    if (toleranceData.lower_tolerance === undefined || toleranceData.upper_tolerance === undefined) {
                        $('#weight-status').val('Tolerance values not found.').css('color', 'red');
                        return;
                    }

                    var lowerTolerance = parseFloat(toleranceData.lower_tolerance);
                    var upperTolerance = parseFloat(toleranceData.upper_tolerance);
                    var unit = toleranceData.unit;

                    console.log('Fetched tolerance values:', lowerTolerance, upperTolerance, unit);

                    // Adjust tolerance based on unit
                    if (unit.toLowerCase() === 'gm') {
                        lowerTolerance /= 1000;
                        upperTolerance /= 1000;
                    }

                    console.log('Tolerance values after conversion:', lowerTolerance, upperTolerance);

                    // Fetch the polybag and mould weights
                    $.ajax({
                        url: '/get_product_details_by_order/' + productionOrderNo + '/',
                        type: 'GET',
                        success: function (productData) {
                            var polybagWeight = parseFloat(productData.polybag_weight);
                            var mouldWeight = parseFloat(productData.mould_weight);
                            var totalWeight = polybagWeight + mouldWeight;

                            console.log('Polybag Weight:', polybagWeight, 'Mould Weight:', mouldWeight, 'Total Weight:', totalWeight);

                            if (isNaN(totalWeight)) {
                                console.error('Total weight is NaN, check polybag and mould weight values.');
                                $('#weight-status').val('Error calculating total weight.').css('color', 'red');
                                return;
                            }

                            var toleranceLower = totalWeight - lowerTolerance;
                            var toleranceUpper = totalWeight + upperTolerance;

                            console.log('Tolerance range after conversion:', toleranceLower, toleranceUpper);

                            if (weight >= toleranceLower && weight <= toleranceUpper) {
                                // Weight is within tolerance, proceed to print
                                $('#weight-status').val('Stable').css('color', 'green');
                                $('#live-weight-display').css('color', 'green');
                                console.log('Weight within tolerance, proceeding to print at', new Date().toLocaleTimeString());
                                printLabel(productionOrderNo, weight);
                            } else {
                                $('#weight-status').val('Weight out of tolerance.').css('color', 'red');
                                showAlert('Weight is not within the tolerance range!', 'danger');
                                console.log('Weight out of tolerance range:', weight, 'at', new Date().toLocaleTimeString());
                            }
                        },
                        error: function (xhr, status, error) {
                            $('#weight-status').val('Error fetching product details.').css('color', 'red');
                            if (xhr.status === 401) {
                                showAlert('Session expired. Redirecting to login page.', 'danger');
                                window.location.href = '/login/';
                            }
                        }
                    });
                },
                error: function (xhr, status, error) {
                    $('#weight-status').val('Error fetching tolerance values.').css('color', 'red');
                    if (xhr.status === 401) {
                        showAlert('Session expired. Redirecting to login page.', 'danger');
                        window.location.href = '/login/';
                    }
                }
            });
        }

        function printLabel(productionOrderNo, weight) {
            var batch = $('#batch').val();
            var itemCode = $('#item-code').val();
            var itemName = $('#product-name').val();
            var mrp = $('#mrp').val();
            var expDate = $('#exp-date').val();
            var qty = $('#qty').val();

            console.log('Sending print request with weight:', weight, 'at', new Date().toLocaleTimeString());

            $.ajax({
                url: '/generate_prn/',
                type: 'POST',
                data: {
                    batch: batch,
                    item_code: itemCode,
                    item_name: itemName,
                    mrp: mrp,
                    exp_date: expDate,
                    weight: weight,
                    qty: qty,
                    production_order_no: productionOrderNo,
                    csrfmiddlewaretoken: csrftoken
                },
                success: function (data) {
                    console.log('Print response received:', data, 'at', new Date().toLocaleTimeString());
                    if (data.status === 'success') {
                        showAlert(data.num_prints + ' Label Printed Successfully!!', 'success');
                        console.log('Print success:', data, 'at', new Date().toLocaleTimeString());
                        setTimeout(() => {
                            $('#alert-container .alert').fadeOut(500, function () {
                                $(this).remove();
                            });
                        }, 2000);
                        fetchCartonLabels(); // Update the carton label table
                    } else {
                        showAlert('Error: ' + data.message, 'danger');
                        console.log('Print error:', data, 'at', new Date().toLocaleTimeString());
                    }
                },
                error: function (xhr, status, error) {
                    var response = xhr.responseJSON;
                    if (response && response.message) {
                        showAlert('Error: ' + response.message, 'danger');
                        console.log('Print error:', response.message);
                    } else {
                        showAlert('An unexpected error occurred.', 'danger');
                        console.log('Unexpected error:', error);
                    }
                }
            });
        }

        setInterval(getLiveWeight, 1000); // Fetch live weight every second

        // Initialize Select2 for the production order dropdown
        $('#select-production-order').select2({
            width: '100%',
            allowClear: true,
            placeholder: 'Select PO number'
        });

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        // Fetch production order numbers and populate the dropdown
        $.ajax({
            url: '/get_production_order_numbers_by_line/',
            type: 'GET',
            success: function (data) {
                var productionOrderSelect = $('#select-production-order');
                productionOrderSelect.empty(); // Clear existing options
                productionOrderSelect.append('<option></option>'); // Allow for the placeholder

                data.forEach(function (order) {
                    if (!order.polybag_print_status) { // Only add orders that are not completed
                        productionOrderSelect.append(new Option(order.production_order_no, order.production_order_no));
                    }
                });
            },
            error: function (xhr, status, error) {
                console.error('Error fetching production order numbers:', error);
            }
        });

        // Fetch product details based on selected production order number
        $('#select-production-order').change(function () {
            var productionOrderNo = $(this).val();
            if (productionOrderNo) {
                $.ajax({
                    url: '/get_product_details_by_order/' + productionOrderNo + '/',
                    type: 'GET',
                    success: function (data) {
                        $('#item-code').val(data.item_code);
                        $('#product-name').val(data.item_name);
                        $('#batch').val(data.batch);
                        $('#mrp').val(data.mrp);
                        $('#mfg-date').val(data.mfg_date);
                        $('#exp-date').val(data.exp_date);
                        $('#qty').val(data.qty);
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching product details:', error);
                    }
                });
            } else {
                $('#item-code').val('');
                $('#product-name').val('');
                $('#batch').val('');
                $('#mrp').val('');
                $('#mfg-date').val('');
                $('#exp-date').val('');
                $('#qty').val('');
            }
        });

        function validatePolybagQR(qr_code) {
            // Example validation: Check if QR code starts with "PB" (PolyBag) or any other logic
            return qr_code.startsWith("P");
        }

        // Auto-print carton label on QR code input
        $('#qr-code').on('input', function () {
            var qr_code = $(this).val().trim();
            if (qr_code) {
                if (!validatePolybagQR(qr_code)) {
                    showAlert('Please scan a valid Polybag QR code!', 'danger');
                    $('#qr-code').val('');
                    return;
                }
                $.ajax({
                    url: '/generate_carton/',
                    type: 'POST',
                    data: {
                        qr_code: qr_code,
                        carton_type: 'single',
                        csrfmiddlewaretoken: csrftoken
                    },
                    success: function (response) {
                        if (response.status === 'success') {
                            showAlert('Carton Label Printed Successfully', 'success');
                            fetchCartonLabels(); // Refresh the carton labels table
                            $('#qr-code').val(''); // Clear the input field after printing
                        } else {
                            showAlert('Error: ' + response.message, 'danger');
                        }
                    },
                    error: function (xhr, status, error) {
                        var response = xhr.responseJSON;
                        if (response && response.message) {
                            showAlert('Error: ' + response.message, 'danger');
                        } else {
                            showAlert('An unexpected error occurred.', 'danger');
                        }
                    }
                });
            }
        });

        function fetchCartonLabels() {
            $.ajax({
                url: '/get_single_carton_list/', // URL to fetch the carton labels
                type: 'GET',
                success: function (data) {
                    var tableBody = $('#cartonLabelsTable tbody');
                    tableBody.empty(); // Clear the table body

                    // Only show the most recent record
                    if (data.length > 0) {
                        var label = data[data.length - 1]; // Get the last record
                        var row = '<tr>' +
                            '<td>' + label.qr_code + '</td>' +
                            '<td>' + label.item_code + '</td>' +
                            '<td>' + label.batch + '</td>' +
                            '<td>' + label.printed_by + '</td>' +
                            '<td>' + label.printed_date + '</td>' +
                            '</tr>';
                        tableBody.append(row);
                    }
                },
                error: function (xhr, status, error) {
                    alert('Error: ' + error);
                }
            });
        }

        function fetchPolybagCount(item_code, batch) {
            $.ajax({
                url: '/get_polybag_count/', // URL to fetch the polybag count
                type: 'GET',
                data: {
                    item_code: item_code,
                    batch: batch
                },
                success: function (response) {
                    if (response.polybag_count !== undefined) {
                        $('#polybag-count-input').val(response.polybag_count);
                        $('#polybag-count').show();
                    } else {
                        $('#polybag-count').hide();
                    }
                },
                error: function (xhr, status, error) {
                    alert('Error: ' + error);
                }
            });
        }

        // Show/Hide form fields based on selected label type
        $('input[name="labelType"]').change(function () {
            if ($('#carton').is(':checked')) {
                $('.polybag-fields').hide();
                $('#carton-options').show(); // You can hide this if not needed
                $('#scan-qr-code').show();
                $('#scan-qr-code-bulk').hide();
                $('#print-label-btn').hide();
                $('#print-button').show();
                $('#print-button-bulk').hide();
                $('#cartonLabelsContainer').show();
                fetchCartonLabels(); // Fetch carton labels when carton is selected
            } else {
                $('#carton-options').hide();
                $('.polybag-fields').show();
                $('#scan-qr-code').hide();
                $('#scan-qr-code-bulk').hide();
                $('#print-label-btn').show();
                $('#print-button').hide();
                $('#print-button-bulk').hide();
                $('#cartonLabelsContainer').hide(); // Hide table when carton type is not selected
            }
        });

        // Event handler for printing single carton label
        $('#printCartonLabel').click(function () {
            var qr_code = $('#qr-code').val();

            $.ajax({
                url: '/generate_carton/',
                type: 'POST',
                data: {
                    qr_code: qr_code,
                    carton_type: 'single',
                    csrfmiddlewaretoken: csrftoken
                },
                success: function (response) {
                    if (response.status === 'success') {
                        alert('Carton Label Printed Successfully');
                        fetchCartonLabels(); // Refresh the carton labels table
                        $('#qr-code').val(''); // Clear the input field after printing
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    var response = xhr.responseJSON;
                    if (response && response.message) {
                        alert('Error: ' + response.message);
                    } else {
                        alert('An unexpected error occurred.');
                    }
                }
            });
        });

        // Event handler for printing bulk carton label
        $('#printCartonLabelBulk').click(function () {
            var qr_code_bulk = $('#qr-code-bulk').val();

            $.ajax({
                url: '/generate_carton/',
                type: 'POST',
                data: {
                    qr_code: qr_code_bulk,
                    carton_type: 'bulk',
                    csrfmiddlewaretoken: csrftoken
                },
                success: function (response) {
                    if (response.status === 'success') {
                        alert('Bulk Carton Label Printed Successfully');
                        fetchCartonLabels(); // Refresh the carton labels table
                        $('#qr-code-bulk').val(''); // Clear the input field after printing
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    alert('Error: ' + error);
                }
            });
        });

        $('#carton-labels-nav').click(function () {
            $('#bulk-carton').prop('checked', true);
            $('.polybag-fields').hide();
            $('#carton-options').hide();
            $('#scan-qr-code').hide();
            $('#scan-qr-code-bulk').show();
            $('#print-label-btn').hide();
            $('#print-button').hide();
            $('#print-button-bulk').show();
            $('#cartonLabelsContainer').show();
            fetchCartonLabels();
        });

        // Redirect to login if session expires
        function checkSession() {
            $.ajax({
                url: '/check_session/',
                type: 'GET',
                success: function (data) {
                    if (data.status === 'expired') {
                        showAlert('Session expired. Redirecting to login page.', 'danger');
                        window.location.href = '/login/';
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error checking session:', error);
                }
            });
        }

        setInterval(checkSession, 30000); // Check session every 30 seconds
    });
</script>

</body>
{% endblock %}
